<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>G·ª¨I T√åNH Y√äU C·ª¶A EM</title>
  <style>
    /* ====== N·ªÄN & SCENE ====== */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      font-family: 'Arial', sans-serif;
      perspective: 1000px;
      background-image: url('chiquyen.jpg'); /* ƒê∆∞·ªùng d·∫´n ·∫£nh n·ªÅn */
      background-size: cover;       /* ·∫¢nh ph·ªß ƒë·∫ßy */
      background-position: center;  /* CƒÉn gi·ªØa */
      background-repeat: no-repeat; /* Kh√¥ng l·∫∑p */
      touch-action: none;
    }
    #scene {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.15s ease-out;

      display: flex;
      justify-content: center;  /* cƒÉn ngang */
      align-items: center;      /* cƒÉn d·ªçc */
      flex-direction: column;   /* n·∫øu c√≥ nhi·ªÅu d√≤ng ch·ªØ */
    }

    .falling-text, .heart, .rose {
      position: absolute;
      pointer-events: none;
      transform-style: preserve-3d;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(0deg);
    }

    .falling-text {
      color: #ff69b4;
      font-size: 5vw;
      white-space: nowrap;
      opacity: 0.9;
      text-shadow:
        0 0 5px rgba(255, 105, 180, 0.8),
        0 0 10px rgba(255, 105, 180, 0.6);
      animation: fadeInOut 2s infinite alternate;
    }

    .heart {
      color: #ff1493;
      font-size: 5vw;
      opacity: 0.9;
      text-shadow: 0 0 3px #ff1493, 0 0 5px #ff1493;
      animation: float 4s infinite ease-in-out;
    }

    .rose {
      color: #ff4040;
      font-size: 4vw;
      opacity: 0.9;
      transform: rotate(45deg);
      text-shadow: 0 0 3px #ff4040, 0 0 5px #ff4040;
      animation: float 4s infinite ease-in-out;
    }

    /* ƒê·ªô s√¢u */
    .layer-1 { transform: translateZ(-300px); opacity: 0.8;  font-size: 3vw; }
    .layer-2 { transform: translateZ(-150px); opacity: 0.85; font-size: 4vw; }
    .layer-3 { transform: translateZ(0px);    opacity: 0.9;  font-size: 5vw; }
    .layer-4 { transform: translateZ(150px);  opacity: 0.95; font-size: 6vw; }
    .layer-5 { transform: translateZ(300px);  opacity: 1;    font-size: 7vw; }

    @keyframes fadeInOut {
      from { opacity: 0.9; }
      to   { opacity: 0.6; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50%      { transform: translateY(-5px); }
    }

    @media (max-width: 768px) {
      .falling-text { font-size: 6vw; }
      .heart        { font-size: 6vw; }
      .rose         { font-size: 5vw; }
      .layer-1 { font-size: 4vw; }
      .layer-2 { font-size: 5vw; }
      .layer-3 { font-size: 6vw; }
      .layer-4 { font-size: 7vw; }
      .layer-5 { font-size: 8vw; }
    }

    /* ====== BADGE HI·ªÇN TH·ªä M√É (?code=...) ====== */
    .code-badge{
      position:fixed; top:16px; right:16px;
      background:rgba(255,255,255,.85);
      border:1px solid #e5e7eb; border-radius:12px;
      padding:12px 14px; backdrop-filter:blur(6px);
      display:flex; gap:8px; align-items:center; z-index:9999;
      box-shadow:0 8px 24px rgba(0,0,0,.12)
    }
    .code-badge .label{font-weight:600}
    .code-badge .value{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:14px; max-width:38vw; overflow-wrap:anywhere
    }
    .code-badge button{
      border:1px solid #ddd; border-radius:8px; padding:4px 8px;
      cursor:pointer; background:#fff
    }
    .code-badge .muted{font-size:12px;color:#6b7280}
    .code-help{right:auto; left:16px}
  </style>
</head>
<body>
  <div id="scene"></div>

  <!-- Badge hi·ªÉn th·ªã m√£ ƒë√£ ch·∫°y -->
  <div class="code-badge" id="code-badge" hidden>
    <span class="label">M√£ ƒë√£ ch·∫°y:</span>
    <span class="value" id="code-value"></span>
    <button id="copy-btn" title="Sao ch√©p">Copy</button>
  </div>

  <!-- H∆∞·ªõng d·∫´n khi ch∆∞a c√≥ ?code -->
  <div class="code-badge code-help" id="code-help" hidden>
    <span class="muted">Th√™m <b>?code=YOUR_CODE</b> v√†o URL ƒë·ªÉ hi·ªÉn th·ªã m√£.</span>
  </div>

  <audio id="backgroundMusic" loop></audio>

  <script>
    /* ====== TEXT & HI·ªÜU ·ª®NG ====== */
    const texts = [
      "Th∆∞∆°ng ch·ªã nhi·ªÅu l·∫Øm lu√¥n ƒë√≥ üòò",
      "Ch·ªã l√† t√¨nh y√™u to b·ª± c·ªßa em",
      "Y√™u ch·ªã ƒë·∫∑c bi·ªát c·ªßa em üíïüíï",
      "CH√öC CH·ªä NG√ÄY M·ªöI VUI V·∫∫ ·∫† ü•∞",
      "·ªû b√™n ch·ªã l√† ƒëi·ªÅu ng·ªçt ng√†o nh·∫•t em c√≥",
      "C·∫£m ∆°n ch·ªã v√¨ ƒë√£ ƒë·∫øn v√† l√†m tim em rung rinh m·ªói ng√†yü•∞",
      "Cho em ƒë∆∞·ª£c y√™u ch·ªã thi·ªát nhi·ªÅu, nhi·ªÅu h∆°n h√¥m qua, √≠t h∆°n ng√†y mai nha",
      "H√Ä TH·ªä QUY√äN"
    ];

    const scene = document.getElementById("scene");
    const audio = document.getElementById("backgroundMusic");
    let rotateX = 0, rotateY = 0;
    let targetRotateX = 0, targetRotateY = 0;
    let lastTouchX = 0, lastTouchY = 0;
    let lastMouseX = 0, lastMouseY = 0;
    let isDragging = false;
    const maxTexts = 15;
    let activeTexts = [];

    function filledCell(cell) { return cell !== '' && cell != null; } // (ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi code c≈© n·∫øu c·∫ßn)

    function checkCollision(newX, newY, newWidth, newHeight) {
      for (let text of activeTexts) {
        const rect = text.getBoundingClientRect();
        if (newX < rect.right && newX + newWidth > rect.left &&
            newY < rect.bottom && newY + newHeight > rect.top) {
          return true;
        }
      }
      return false;
    }

    document.addEventListener("touchstart", (e) => {
      e.preventDefault();
      lastTouchX = e.touches[0].clientX;
      lastTouchY = e.touches[0].clientY;
      isDragging = true;
      if (audio.paused) {
        audio.play().catch(err => console.log("Kh√¥ng th·ªÉ ph√°t t·ª± ƒë·ªông:", err));
      }
    }, { passive: false });

    document.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const touchX = e.touches[0].clientX;
      const touchY = e.touches[0].clientY;

      const deltaX = (touchX - lastTouchX) * 0.5;
      const deltaY = (touchY - lastTouchY) * 0.5;

      targetRotateY += deltaX;
      targetRotateX -= deltaY;

      lastTouchX = touchX;
      lastTouchY = touchY;
    }, { passive: false });

    document.addEventListener("touchend", () => {
      isDragging = false;
      targetRotateX = 0;
      targetRotateY = 0;
    });

    document.addEventListener("mousedown", (e) => {
      lastMouseX = e.clientX;
      lastMouseY = e.clientY;
      isDragging = true;
    });

    document.addEventListener("mousemove", (e) => {
      if (isDragging) {
        const deltaX = (e.clientX - lastMouseX) * 0.5;
        const deltaY = (e.clientY - lastMouseY) * 0.5;

        targetRotateY += deltaX;
        targetRotateX += deltaY;

        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
      }
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      targetRotateX = 0;
      targetRotateY = 0;
    });

    function updateRotation() {
      rotateX += (targetRotateX - rotateX) * 0.1;
      rotateY += (targetRotateY - rotateY) * 0.1;
      scene.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      requestAnimationFrame(updateRotation);
    }
    updateRotation();

    function getRandomLayer() {
      const layers = ['layer-1', 'layer-2', 'layer-3', 'layer-4', 'layer-5'];
      return layers[Math.floor(Math.random() * layers.length)];
    }

    function createFallingText(initial = false) {
      if (activeTexts.length >= maxTexts) return;

      const text = document.createElement("div");
      text.className = "falling-text";
      text.innerText = texts[Math.floor(Math.random() * texts.length)];

      let startX, startY;
      const textWidth = text.offsetWidth || 200;
      const textHeight = text.offsetHeight || 50;
      let attempts = 0;
      const maxAttempts = 10;

      do {
        startX = Math.random() * (window.innerWidth - textWidth);
        startY = initial ? Math.random() * (window.innerHeight - textHeight) : -50;
        attempts++;
      } while (checkCollision(startX, startY, textWidth, textHeight) && attempts < maxAttempts);

      if (attempts >= maxAttempts) {
        startX = Math.random() * (window.innerWidth - textWidth);
        startY = -50;
      }

      const layerClass = getRandomLayer();
      text.classList.add(layerClass);
      text.style.left = startX + "px";
      text.style.top = startY + "px";
      text.style.color = `hsl(${Math.random() * 360}, 80%, 70%)`;

      scene.appendChild(text);
      activeTexts.push(text);

      let posY = startY;
      const speed = Math.random() * 1 + 0.5;

      function animate() {
        posY += speed;
        text.style.top = posY + "px";

        if (posY > window.innerHeight + 50) {
          text.remove();
          activeTexts = activeTexts.filter(t => t !== text);
        } else {
          requestAnimationFrame(animate);
        }
      }
      animate();
    }

    function createHeart(initial = false) {
      const layers = ['layer-1', 'layer-2', 'layer-3', 'layer-4', 'layer-5'];
      layers.forEach(layerClass => {
        const heart = document.createElement("div");
        heart.className = "heart";
        heart.innerText = "‚ô•";

        const startX = Math.random() * window.innerWidth;
        heart.classList.add(layerClass);
        heart.style.left = startX + "px";
        heart.style.top = initial ? (Math.random() * window.innerHeight) + "px" : "-50px";

        scene.appendChild(heart);

        let posY = initial ? parseFloat(heart.style.top) : -50;
        const speed = Math.random() * 0.8 + 0.4;

        function animateHeart() {
          posY += speed;
          heart.style.top = posY + "px";

          if (posY > window.innerHeight + 50) {
            heart.remove();
          } else {
            requestAnimationFrame(animateHeart);
          }
        }
        animateHeart();
      });
    }

    function createRose(initial = false) {
      const rose = document.createElement("div");
      rose.className = "rose";
      rose.innerText = "‚ô•";

      const startX = Math.random() * window.innerWidth;
      const layerClass = getRandomLayer();
      rose.classList.add(layerClass);
      rose.style.left = startX + "px";
      rose.style.top = initial ? (Math.random() * window.innerHeight) + "px" : "-50px";

      scene.appendChild(rose);

      let posY = initial ? parseFloat(rose.style.top) : -50;
      const speed = Math.random() * 0.8 + 0.4;

      function animateRose() {
        posY += speed;
        rose.style.top = posY + "px";

        if (posY > window.innerHeight + 50) {
          rose.remove();
        } else {
          requestAnimationFrame(animateRose);
        }
      }
      animateRose();
    }

    for (let i = 0; i < 8; i++) createFallingText(true);
    for (let i = 0; i < 2; i++) createHeart(true);
    for (let i = 0; i < 5; i++) createRose(true);

    setInterval(createFallingText, 500);
    setInterval(createHeart, 1500);
    setInterval(createRose, 700);

    /* ====== C√ÅCH A: ƒë·ªçc ?code=... v√† hi·ªÉn th·ªã badge ====== */
    (function () {
      const p = new URLSearchParams(location.search);
      const runCode = p.get('code');
      const badge = document.getElementById('code-badge');
      const help  = document.getElementById('code-help');
      const valEl = document.getElementById('code-value');
      const copy  = document.getElementById('copy-btn');

      if (runCode) {
        valEl.textContent = runCode;
        badge.hidden = false;
        copy.onclick = async () => {
          try {
            await navigator.clipboard.writeText(runCode);
            const t = copy.textContent;
            copy.textContent = 'ƒê√£ sao ch√©p';
            setTimeout(() => (copy.textContent = t), 1200);
          } catch (e) {
            alert('Kh√¥ng sao ch√©p ƒë∆∞·ª£c: ' + e);
          }
        };
      } else {
        help.hidden = false;
      }
    })();
  </script>
</body>
</html>
